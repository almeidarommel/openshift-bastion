# Deploy OCP on vSphere

### Prerequisites Preparation

The following services are pre-requisites for OpenShift 4.2 installation on vSphere (https://docs.openshift.com/container-platform/4.2/installing/installing_vsphere/installing-vsphere.html#installation-infrastructure-user-infra_installing-vsphere[see more on the official docs for OpenShift]) :

- RESOURCES
- NETWORK
- DNS
- DHCP
- Load Balancer
- vSphere 6.7U2

### Minimum resource requirements

image::images/servers-resources.png[Servers Resources]

### Networking requirements for user-provisioned infrastructure

**All machines to all machines**

image::images/networking.png[Network]

### NETWORK TOPOLOGY REQUIREMENTS
The infrastructure that you provision for your cluster must meet the following network topology requirements.

[NOTE]
===
OpenShift Container Platform requires all nodes to have internet access to pull images for platform containers and provide telemetry data to Red Hat.
===

**Load balancers** 
Before you install OpenShift Container Platform, you must provision two layer-4 load balancers. The API requires one load balancer and the default Ingress Controller needs the second load balancer to provide ingress to applications.

image::images/networking01.png[Network Resources]

### ETHERNET ADAPTOR HARDWARE ADDRESS REQUIREMENTS
When provisioning VMs for the cluster, the ethernet interfaces configured for each VM must use a MAC address from the VMware Organizationally Unique Identifier (OUI) allocation ranges:

00:05:69:00:00:00 to 00:05:69:FF:FF:FF

00:0c:29:00:00:00 to 00:0c:29:FF:FF:FF

00:1c:14:00:00:00 to 00:1c:14:FF:FF:FF

00:50:56:00:00:00 to 00:50:56:FF:FF:FF

If a MAC address outside the VMware OUI is used, the cluster installation will not succeed.

### Required DNS records

##### Set your DNS spreedsheet

link:https://github.com/jonascavalcantineto/ocp-bootstrap-ignition/blob/release-v4.3-vsphere6.7U2/documentation/spreedsheets/ocp-dns-registries.xlsx[get the XLSX]

[cols="5,2,3",options=header]
|===
|Component	
|Record	
|Description

|Kubernetes API
|api.<cluster_name>.<base_domain>
|This DNS record must point to the load balancer for the control plane machines. This record must be resolvable by both clients external to the cluster and from all the nodes within the cluster.

|Kubernetes API
|api-int.<cluster_name>.<base_domain>
|This DNS record must point to the load balancer for the control plane machines. This record must be resolvable from all the nodes within the cluster.The API server must be able to resolve the worker nodes by the host names that are recorded in Kubernetes. If it cannot resolve the node names, proxied API calls can fail, and you cannot retrieve logs from Pods.

|Routes
|*.apps.<cluster_name>.<base_domain>
|A wildcard DNS record that points to the load balancer that targets the machines that run the Ingress router pods, which are the worker nodes by default. This record must be resolvable by both clients external to the cluster and from all the nodes within the cluster.

|etcd
|etcd-<index>.<cluster_name>.<base_domain>
|OpenShift Container Platform requires DNS records for each etcd instance to point to the control plane machines that host the instances. The etcd instances are differentiated by <index> values, which start with 0 and end with n-1, where n is the number of control plane machines in the cluster. The DNS record must resolve to an unicast IPv4 address for the control plane machine, and the records must be resolvable from all the nodes in the cluster.

|etcd
|_etcd-server-ssl._tcp.<cluster_name>.<base_domain>
|For each control plane machine, OpenShift Container Platform also requires a SRV DNS record for etcd server on that machine with priority 0, weight 10 and port 2380. A cluster that uses three control plane machines requires the following records:
|===

[cols="3,2,2,2,2,2,2,8",options=header]
|===
|# _service._proto.name.                            
|TTL    
|class 
|SRV 
|priority 
|weight 
|port 
|target

|_etcd-server-ssl._tcp.<cluster_name>.<base_domain>  
|86400 
|IN    
|SRV 
|0        
|10     
|2380 
|etcd-0.<cluster_name>.<base_domain>.

|_etcd-server-ssl._tcp.<cluster_name>.<base_domain>  
|86400 
|IN    
|SRV 
|0        
|10     
|2380 
|etcd-1.<cluster_name>.<base_domain>.


|_etcd-server-ssl._tcp.<cluster_name>.<base_domain>  
|86400 
|IN    
|SRV 
|0        
|10     
|2380 etcd-2.<cluster_name>.<base_domain>.
|===

*_DNS Settings:_ Example*
----
[user0@infra-services ~]$ sudo cat /etc/named.conf
acl internal_nets { 10.0.0.0/16; };
options {
listen-on port 53 { 127.0.0.1; 10.0.0.5; };
listen-on-v6 port 53 { none; };
directory "/var/named";
dump-file "/var/named/data/cache_dump.db";
statistics-file "/var/named/data/named_stats.txt";
memstatistics-file "/var/named/data/named_mem_stats.txt";
secroots-file "/var/named/data/named.secroots";
(...)
zone "ocp1.rhbr-labs.com" {
type master;
file "ocp1.rhbr-labs.com.zone";
allow-query { any; };
allow-transfer { none; };
allow-update { none; };
};
zone "1.0.10.in-addr.arpa" {
type master;
file "1.0.10.in-addr.arpa.zone";
allow-query { any; };
allow-transfer { none; };
allow-update { none; };
};

[user0@infra-services ~]# sudo cat /var/named/ocp.rhbr-labs.com.zone 
$ORIGIN .
$TTL 3600	; 1 hour
etice.corp		IN SOA	ns1.ocp.rhbr-labs.com. netmaster.ocp.rhbr-labs.com. (
				2020030501 ; serial
				86400      ; refresh (1 day)
				3600       ; retry (1 hour)
				86400      ; expire (1 day)
				3600       ; minimum (1 hour)
				)
			NS	ns2.ocp.rhbr-labs.com.
			NS	ns3.ocp.rhbr-labs.com.
			NS	ns1.ocp.rhbr-labs.com.
$ORIGIN etice.corp.
;CLUSTER-01 K8S
$ORIGIN ocp1.etice.corp.
lb		CNAME		host30.ocp.rhbr-labs.com.
api		CNAME		host30.ocp.rhbr-labs.com.
api-int		CNAME		host30.ocp.rhbr-labs.com.
master-0	A		192.168.0.110
master-1	A		192.168.0.111
master-2	A		192.168.0.112
worker-0	A		192.168.0.113
worker-1	A		192.168.0.114
worker-2	A		192.168.0.115
worker-4	A		192.168.0.116
etcd-0		A		192.168.0.110	
etcd-1		A		192.168.0.111
etcd-2		A		192.168.0.112
bootstrap	A		192.168.0.155
_etcd-server-ssl._tcp		SRV		0		10		2380	 etcd-0	
_etcd-server-ssl._tcp		SRV     0       10      2380     etcd-1
_etcd-server-ssl._tcp		SRV     0       10      2380     etcd-2



[user0@infra-services ~]# sudo cat /var/named/0.168.192.in-addr.arpa
$ORIGIN .
$TTL 3600	; 1 hour
3.26.172.in-addr.arpa	IN SOA	ns1.ocp.rhbr-labs.com. netmaster.ocp.rhbr-labs.com. (
				2020030501 ; serial
				86400      ; refresh (1 day)
				3600       ; retry (1 hour)
				86400      ; expire (1 day)
				3600       ; minimum (1 hour)
				)
			NS	ns1.ocp.rhbr-labs.com.
			NS	ns2.ocp.rhbr-labs.com.
			NS	ns3.ocp.rhbr-labs.com.
$ORIGIN 3.26.172.in-addr.arpa.
110		PTR	master-0.ocp1.ocp.rhbr-labs.com.
111		PTR	master-1.ocp1.ocp.rhbr-labs.com.
112		PTR	master-2.ocp1.ocp.rhbr-labs.com.
113		PTR	worker-0.ocp1.ocp.rhbr-labs.com.
114		PTR	worker-1.ocp1.ocp.rhbr-labs.com.
115		PTR	worker-2.ocp1.ocp.rhbr-labs.com.
116		PTR	worker-3.ocp1.ocp.rhbr-labs.com.

----

*_DHCP:_*

----
[user0@infra-services ~]# sudo cat /etc/dhcp/dhcpd.conf
default-lease-time 900;
max-lease-time 7200;
subnet 10.0.0.0 netmask 255.255.0.0 {
option routers 10.0.0.2;
option subnet-mask 255.255.0.0;
option domain-name-servers 10.0.0.5;
next-server 10.0.0.5;
}

#### CLUSTER OCP
host bootstrap-0 {
    hardware ethernet 00:50:56:01:00:01;
    fixed-address 10.0.0.100;
    option host-name "bootstrap-0.ocp.rhbr-labs.com";
}
host master-0 {
    hardware ethernet 00:50:56:01:00:02;
    fixed-address 10.0.0.101;
    option host-name "master-0.ocp.rhbr-labs.com";
}
(...)
----

*_HAProxy Load Balancer:_*

----
[root@infra-services ~]# sudo cat /etc/haproxy/haproxy.cfg
global
log 127.0.0.1 local2
chroot /var/lib/haproxy
pidfile /var/run/haproxy.pid
maxconn 4000
user haproxy
group haproxy
daemon
stats socket /var/lib/haproxy/stats
ssl-default-bind-ciphers PROFILE=SYSTEM
ssl-default-server-ciphers PROFILE=SYSTEM

defaults
mode http
log global
option httplog
option dontlognull
option http-server-close
option forwardfor except 127.0.0.0/8
option redispatch
retries 3
(...)

#### BEGIN CLUSTER0

frontend ocp4-kubernetes-api-server
mode tcp
option tcplog
bind api.ocp.rhbr-labs.com:6443
default_backend ocp4-kubernetes-api-server

frontend ocp4-kubernetes-api-int-server
mode tcp
option tcplog
bind api-int.ocp.rhbr-labs.com:6443
default_backend ocp4-kubernetes-api-server
(...)

backend ocp4-kubernetes-api-server
mode tcp
balance source
server boostrap-0-0 bootstrap-0.ocp.rhbr-labs.com:6443 check
server master-0-0 master-0.ocp.rhbr-labs.com:6443 check
server master-1-0 master-1.ocp.rhbr-labs.com:6443 check
server master-2-0 master-2.ocp.rhbr-labs.com:6443 check

backend ocp4-machine-config-server
mode tcp
balance source
server bootstrap-0-0 bootstrap-0.ocp.rhbr-labs.com:22623 check
server master-0-0 master-0.ocp.rhbr-labs.com:22623 check
server master-1-0 master-1.ocp.rhbr-labs.com:22623 check
server master-2-0 master-2.ocp.rhbr-labs.com:22623 check
----


### Pre-requisites validation

Check if the A, PTR and SRV records of the DNS are correctly set:

*Checking A records:*
----
export GUID="<GUID>"

[user0@infra-services ~]$ dig bootstrap-0.ocp$GUID.rhbr-labs.com +short
10.0.0.100
[user0@infra-services ~]$ dig master-0.ocp$GUID.rhbr-labs.com +short
10.0.0.101
[user0@infra-services ~]$ dig worker-0.ocp$GUID.rhbr-labs.com +short
10.0.0.102
----

*Checking PTR records:*
----
[user0@infra-services ~]$ dig -x 10.0.0.100 +short
bootstrap-0.ocp.rhbr-labs.com.
[user0@infra-services ~]$ dig -x 10.0.0.101 +short
master-0.ocp.rhbr-labs.com.
[user0@infra-services ~]$ dig -x 10.0.0.102 +short
worker-0.ocp.rhbr-labs.com.
----

*Checking API records:*
----
[user0@infra-services ~]$ dig api.ocp$GUID.rhbr-labs.com +short
10.0.0.5
[user0@infra-services ~]$ dig api-int.ocp$GUID.rhbr-labs.com +short
10.0.0.5
----

*Checking APPs wildcard record:*
----
[user0@infra-services ~]$ dig *.apps.ocp$GUID.rhbr-labs.com +short
10.0.0.5
----

*Checking SRV records:*
----
[user0@infra-services ~]$ dig _etcd-server-ssl._tcp.ocp$GUID.rhbr-labs.com SRV +short
0 10 2380 etcd-0.ocp.rhbr-labs.com.
----

