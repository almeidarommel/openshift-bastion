---
- hosts: 
    - masters
    - infras
    - appnodes
  
  vars:
    rhel-pkgs: [rhel-7-server-rpms, rhel-7-server-ose-3.11-rpms, rhel-7-server-rh-common-rpms, rhel-7-server-ansible-2.8-rpms]
    yum-pkgs: [wget, git, net-tools, bind-utils, iptables-services, bridge-utils, bash-completion, kexec-tools, sos, psacct, yum-utils]
    
  tasks:
    - name: Clean all Repositories and make repolist
      shell: yum clean all && yum repolist

    - name: Configure Selinux Policy
      selinux:
        policy: targeted
        state: enforcing

    - name: Active Openshift Repositories
      command: "subscription-manager repos --enable={{ item }}"
      with_items:
        - "{{ rhel-pkgs }}"
        
    - name: Install Required Packages
      yum: 
        name: {{ item }} 
        state: installed
      with_items:
      - "{{ yum-pkgs }}"
      
    - name: Insert/Update NM_CONTROLLED and PEERDNS
      blockinfile:
        path: /etc/sysconfig/network-scripts/ifcfg-{{ ansible_default_ipv4.interface }}
        block: |
          NM_CONTROLLED=yes
          PEERDNS=yes

    - name: Install Network Manager
      yum:
        name: NetworkManager
        state:  latest

    - name: Enable Network Manager
      service: name=NetworkManager enabled=true state=started

    - name: Setting swap to off
      blockinfile:
        path: /etc/bashrc
        block: |
          swapoff -a

    - name: Diable swap on OS
      command: swapoff -a 
      
    - name: Enable Firewall
      service:
        name: firewalld 
        state: started 
        enabled: "true"

    - name: Update the System
      yum: state=latest name='*'

    - name: Configure Selinux Policy
      selinux:
        policy: targeted
        state: enforcing